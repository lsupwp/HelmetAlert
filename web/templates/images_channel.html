{% extends "template.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">
                <i class="bi bi-camera-video"></i> Camera: {{ mac_address }}
            </h1>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Live Stream - {{ mac_address }}</h5>
                    <span class="badge" id="status-badge">
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Connecting...
                    </span>
                </div>
                <div class="card-body p-0 bg-dark">
                    <div class="position-relative">
                        <img id="camera-feed" 
                             src="" 
                             alt="Camera Feed" 
                             class="w-100"
                             style="min-height: 400px; object-fit: contain;">
                        <div id="no-signal" class="position-absolute top-50 start-50 translate-middle text-center text-white">
                            <i class="bi bi-camera-video-off display-1"></i>
                            <p class="mt-3">Waiting for camera signal...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row text-center">
                        <div class="col-3">
                            <small class="text-muted">MAC Address:</small>
                            <div class="fw-bold text-truncate">{{ mac_address }}</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Status:</small>
                            <div id="ws-status" class="fw-bold">Disconnected</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">FPS:</small>
                            <div id="fps-counter" class="fw-bold">0</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Frames:</small>
                            <div id="frame-counter" class="fw-bold">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <a href="/images" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to All Cameras
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    #camera-feed {
        display: none;
    }
    #camera-feed.active {
        display: block;
    }
    #no-signal {
        display: block;
    }
    #no-signal.hide {
        display: none;
    }
    .card {
        border-radius: 15px;
        overflow: hidden;
    }
</style>

<script>
    let ws;
    let frameCount = 0;
    let lastTime = Date.now();
    let fps = 0;
    const macAddress = "{{ mac_address }}";

    const cameraFeed = document.getElementById('camera-feed');
    const noSignal = document.getElementById('no-signal');
    const statusBadge = document.getElementById('status-badge');
    const wsStatus = document.getElementById('ws-status');
    const fpsCounter = document.getElementById('fps-counter');
    const frameCounter = document.getElementById('frame-counter');

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(`${protocol}//${window.location.host}/ws/images/view/${macAddress}`);

        ws.onopen = function() {
            console.log('WebSocket Connected');
            statusBadge.className = 'badge bg-success';
            statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> Connected';
            wsStatus.textContent = 'Connected';
            wsStatus.className = 'fw-bold text-success';
        };

        ws.onmessage = function(event) {
            // ตรวจสอบว่าเป็น JSON status message หรือไม่
            try {
                const json = JSON.parse(event.data);
                if (json.type === 'status') {
                    if (json.camera_online) {
                        console.log('Camera is online');
                    } else {
                        console.log('Camera is offline');
                    }
                    return;
                }
            } catch (e) {
                // ไม่ใช่ JSON, เป็นภาพ
            }

            // รับภาพเป็น base64 หรือ blob
            if (typeof event.data === 'string') {
                cameraFeed.src = event.data.startsWith('data:') ? event.data : `data:image/jpeg;base64,${event.data}`;
            } else {
                const blob = new Blob([event.data], { type: 'image/jpeg' });
                cameraFeed.src = URL.createObjectURL(blob);
            }

            // แสดงภาพและซ่อน "no signal"
            cameraFeed.classList.add('active');
            noSignal.classList.add('hide');

            // นับ frames และคำนวณ FPS
            frameCount++;
            frameCounter.textContent = frameCount;

            const now = Date.now();
            const elapsed = (now - lastTime) / 1000;
            if (elapsed >= 1) {
                fps = Math.round(frameCount / elapsed);
                fpsCounter.textContent = fps;
                frameCount = 0;
                lastTime = now;
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocket Error:', error);
            statusBadge.className = 'badge bg-danger';
            statusBadge.innerHTML = '<i class="bi bi-x-circle"></i> Error';
        };

        ws.onclose = function() {
            console.log('WebSocket Disconnected');
            statusBadge.className = 'badge bg-warning';
            statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Disconnected';
            wsStatus.textContent = 'Disconnected';
            wsStatus.className = 'fw-bold text-danger';
            
            cameraFeed.classList.remove('active');
            noSignal.classList.remove('hide');

            setTimeout(connectWebSocket, 3000);
        };
    }

    connectWebSocket();

    // ปิด WebSocket เมื่อออกจากหน้า (กด back หรือปิดหน้า)
    window.addEventListener('beforeunload', function() {
        if (ws) {
            ws.close();
        }
    });

    // ปิด WebSocket เมื่อกดปุ่ม back
    window.addEventListener('pagehide', function() {
        if (ws) {
            ws.close();
        }
    });

    // จัดการเมื่อใช้ browser back button
    window.addEventListener('popstate', function() {
        if (ws) {
            ws.close();
        }
    });

    // ปิด WebSocket เมื่อคลิกลิงก์ back
    document.querySelectorAll('a[href="/images"]').forEach(link => {
        link.addEventListener('click', function(e) {
            if (ws) {
                ws.close();
            }
        });
    });
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
{% endblock %}
